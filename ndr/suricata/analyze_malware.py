import duckdb
import sys
import os
import datetime

def get_parquet_file():
    # Hardcoded for this specific task based on directory listing
    return "logs/eve_merged_2026-01-20_to_2026-01-30.parquet"

def run_query(con, query):
    try:
        return con.sql(query).fetchall()
    except Exception as e:
        print(f"Query Error: {e}")
        return []

def analyze_alerts(con, columns):
    print("Checking for Alerts...")
    if 'alert' not in columns:
        return "## Suricata Alerts\n\nNo 'alert' column found in dataset (No alerts fired).\n"

    query = """
    SELECT 
        src_ip, 
        dest_ip, 
        alert.signature, 
        alert.category, 
        count(*) as count 
    FROM logs 
    WHERE event_type = 'alert'
    GROUP BY src_ip, dest_ip, alert.signature, alert.category
    ORDER BY count DESC
    """
    rows = run_query(con, query)
    
    output = "## Suricata Alerts\n\n"
    if not rows:
        output += "No alerts found.\n"
    else:
        for r in rows:
            output += f"- **Signature:** {r[2]}\n"
            output += f"  - Category: {r[3]}\n"
            output += f"  - Source: {r[0]} -> Dest: {r[1]}\n"
            output += f"  - Count: {r[4]}\n"
            output += "\n"
    return output

def analyze_suspicious_dns(con):
    print("Checking for Suspicious DNS (High Length)...")
    # Simple heuristic: Very long domains often indicate DGA or exfiltration
    query = """
    SELECT 
        src_ip, 
        q.unnest.rrname, 
        length(q.unnest.rrname) as len,
        count(*) as count
    FROM logs, UNNEST(dns.queries) as q
    WHERE event_type = 'dns' 
      AND q.unnest.rrname IS NOT NULL
      AND length(q.unnest.rrname) > 50
    GROUP BY src_ip, q.unnest.rrname
    ORDER BY len DESC
    LIMIT 20
    """
    rows = run_query(con, query)
    
    output = "## Suspicious DNS (Long Domains > 50 chars)\n\n"
    if not rows:
        output += "No long domains found.\n"
    else:
        for r in rows:
            # r: (src_ip, rrname, len, count)
            # indices: 0, 1, 2, 3
            output += f"- {r[1]} (Length: {r[2]}, Count: {r[3]}, Source: {r[0]})\n"
    return output

def analyze_unusual_ports(con):
    print("Checking for Unusual Outbound Traffic...")
    # Traffic to public IPs on non-standard ports
    query = """
    SELECT 
        src_ip, 
        dest_ip, 
        dest_port, 
        proto, 
        app_proto,
        count(*) as count
    FROM logs
    WHERE event_type = 'flow'
      AND dest_ip IS NOT NULL
      AND src_ip IS NOT NULL
      -- Exclude Private IPs (RFC 1918)
      AND NOT (
        dest_ip LIKE '10.%'
        OR dest_ip LIKE '192.168.%'
        OR (dest_ip LIKE '172.%' AND try_cast(split_part(dest_ip, '.', 2) as INTEGER) BETWEEN 16 AND 31)
      )
      -- Exclude Common Ports
      AND dest_port NOT IN (80, 443, 53, 123, 22, 8080)
    GROUP BY src_ip, dest_ip, dest_port, proto, app_proto
    ORDER BY count DESC
    LIMIT 20
    """
    rows = run_query(con, query)
    
    output = "## Unusual Outbound Traffic (Public IPs, Non-Standard Ports)\n\n"
    if not rows:
        output += "No unusual traffic found.\n"
    else:
        output += """| Source | Dest | Port | Proto | App | Count |
|---|---|---|---|---|---|
"""
        for r in rows:
            output += f"| {r[0]} | {r[1]} | {r[2]} | {r[3]} | {r[4]} | {r[5]} |\n"
    return output

def main():
    parquet_file = get_parquet_file()
    print(f"Analyzing {parquet_file}...")
    
    con = duckdb.connect(database=':memory:')
    try:
        con.execute(f"CREATE VIEW logs AS SELECT * FROM read_parquet('{parquet_file}')")
    except Exception as e:
        print(f"Error loading parquet: {e}")
        return

    # Get columns
    cols_info = con.execute("DESCRIBE logs").fetchall()
    columns = [c[0] for c in cols_info]

    report_name = f"malware_analysis_results-{datetime.datetime.now().strftime('%y-%m-%d-%H-%M')}.md"
    
    with open(report_name, 'w') as f:
        f.write("# Malware Analysis Report\n\n")
        f.write(analyze_alerts(con, columns))
        f.write("\n---\n\n")
        f.write(analyze_suspicious_dns(con))
        f.write("\n---\n\n")
        f.write(analyze_unusual_ports(con))
    
    print(f"Analysis complete. Report written to {report_name}")

if __name__ == "__main__":
    main()
